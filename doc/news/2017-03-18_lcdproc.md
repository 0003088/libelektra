# Elektrify LCDproc

- guid: d52657b5-60da-4a21-9679-f8aacf6d6b72
- author: Markus Raab
- pubDate: Sat, 18 Mar 2017 20:43:03 +0100
- shortDesc: Elektrify LCDproc


> LCDproc is a piece of open source software that displays real-time
> system information from your Linux/*BSD box on a LCD.

LCDproc's [website](http://lcdproc.omnipotent.net/) is a bit outdated
but is well-maintained and had a
[release recently](https://github.com/lcdproc/lcdproc/releases).

Like in many projects, it invented its own configuration access and
INI parser which did not evolve with the needs of the project.  As a
consequence inconsistencies and code duplication spread over the source.
For example, the LCDproc configuration access does not support values
that represent display's size (such as `20x4`).  Thus every LCDproc's
module has its own parsing code for such values.

Some days ago (16.03.2017), we met with LCDproc's maintainer Harald
Geyer and discussed the current situation.  We decided that we will
elektrify LCDproc and remove all the configuration access and parsing
code within LCDproc.


## Goals

We formulated three goals:

1.) Users of LCDproc should be able to use `LCDd.conf` as they use it now.
2.) We remove as much code as possible from LCDproc's code base.
3.) Avoid the duplication of configuration specifications (currently in
    `LCDd.conf`, the docbook, in code checking the limits, and the default
    parameter in the code)

Nice-to-have are:

- safe updates: `make install` should not break the current `LCDd.conf`
  as it is already the case in Debian.
- easy migration paths to use other configuration file formats such as YAML.
- The robustness of LCDproc on misconfiguration should be improved.
- Automatic reloading of the daemon when using Elektra to update configuration.
  (manual `SIGHUP`-signals will work even without this feature)
- have physical units like `500ms`

Possible limitations for a first version:

- the `-c` option to specify a different configuration file is somewhat
  against the abstraction Elektra should deliever.  We might create a
  [wrapper script](https://github.com/ElektraInitiative/libelektra/issues/1416)
  that emulates `-c` via mountpoints.

In any case, the [advertised benefits of Elektra](https://www.libelektra.org)
will automatically apply (incomplete list):

- global key database: you can connect other configuration with the
  LCDproc's configuration
- introspectibility: you can check with `kdb`-tool which configuration
  settings LCDproc will receive.
- other configuration file formats can be used instead, e.g. JSON or XML
  (if wanted as personal preference, by default INI will be used)
- Elektra's tool can be used to configure LCDconf, including:
 - `kdb set` to modify individual settings within scripts
 - `kdb editor`, which spawns your favourite editor but validates
   the configuration file before writing it out
 - `kdb qt-gui`, the Qt GUI by Raffael Pancheri
 - The web UI of Elektra currently developed by Daniel Bugl
- Elektra's homepage can be used to share LCD's configuration files,
  and you can use the [curlget plugin](https://master.libelektra.org/src/plugins/curlget)
  to mount these files.
- You can use Shell, Python, or Lua to write small scripts that are executed on
  configuration access.
- Elektra allows you to directly read and write from git
  using the [git plugin](https://master.libelektra.org/src/plugins/gitresolver)
  (even if `LCDd.conf` is not checked out)
- We extensively [test](https://www.libelektra.org/devgettingstarted/testing)
  Elektra with modern techniques such as fuzzing.


## Validation

Instead of `if`s within the code, we will use SpecElektra for validation.
[SpecElektra](https://master.libelektra.org/doc/help/elektra-glossary.md)
is a configuration specification language that allows us to describe
which configuration is valid.

This specification will be installed as part of LCDproc to
`/usr/share/elektra/specifications`.
It uses the [metadata](https://master.libelektra.org/doc/METADATA.ini)
as defined by the plugins to validate configuration changed via
Elektra.

For broken installations or when executing LCDproc from the source
repository, there is also a built-in specification.  The specification
will only be used if the installed one cannot be found.

Thus the configuration validation specification is a normal configuration
file also integrated in Elektra, also the specification can be introspected:
useful for system administrators who want to know about valid entries, but
also for tools like our newly developed web-UI by Daniel Bugl.

The web-UI automatically restricts the interface so that only valid
entries can be entered.  For example, if you should enter a boolean,
only a check box is presented to you.

For more information about validation, see the [tutorial](master.libelektra.org/doc/tutorials/validation.md)


## Code Generation

We are currently developing a high-level API, whose first user will be LCDproc.
In this API, we will make sure during compilation, that configuration access
is done correctly.

This is especially useful when configuration settings get renamed.
Then all places where out-dated configuration settings are used will fail to compile.

In particular code generation is handy thus developers do not need to use strings
to refer to configuration settings and they automatically get easy-to-use enums.

Furthermore, code generation will make sure that a specification (and configuration)
will be found even if no `/etc` or no `/usr` is found.

We also found that we cannot use code generation everywhere.
In generic access code, code generation obviously is limited.


## Risks

Understandably, users might be concerned that such a change will not work or create
problems in the future. Here we will discuss some of the concerns as expressed by
a user.

> Elektra might be going out-of-service.

From history perspective, Elektra received steady development since 2004.
Elektra is a FLOSS project and welcomes everyone to join. In the last
years several people did, with an increasing number per year.

Elektra has a large set of [automated tests](https://build.libelektra.org)
and only a small amount of technical dept. Elektra has no required external
dependencies except libc. So without internal changes, only minimal maintenance
cost is required.

> Elektra is unfinished.

While technically this is true (we did not reach 1.0), now is the best
time to join thus 

Some [time ago](doc/news/2016-06-14_0.8.17.md) we asked in a survey in
which direction Elektra should develop. Most open issues are (in)direct
responses from this wanted direction.

Of course not everything in Elektra is finished.
Some plugins are experimental or proof-of-concept, but they are clearly marked as such.


Even if we stop maintaining Elektra, configuration access code in projects depending on Elektra will
receive the status they usually have now.

> it seems a bit to me like [xkcd: Standards](https://xkcd.com/927/).

Elektra does not invent a new configuration file format but abstracts over them.


> Elektra not being available in the distribution.

As a casual contributor to lcdproc, I'm a bit sceptical of this
project. Its feature list looks nice and all, but 

Harald packages OpenWRT

> If Elektra does not take off and achieve world dominance, will we be worse off than before?

Basically this is what we did the last years: Not only offer an API and wait for world dominance but to offer an implementation that can compete with any configuration library out there. We are not completely there yet (there are some details where specific other libraries are better than Elektra in specific points) but these are not points that the current configuration system of lcdproc supports (not even close). And the libraries that can compete with Elektra have a completely different level on which dependencies they have: Elektra is the only one only requiring libc.

> Do we retain the old way of configuring things, i.e. manually editing a ini file in /etc

Absolutely, you can think of libelektra as a small library in C that reads the ini file like it was done before. So you would have the same INI file as before.

>  and then reloading/restarting the system service?

Elektra does not interfere with restarting. It provides some techniques for reloading but they are optional. So you can tell us your requirements of reloading are, or we also can implement it in the same way as it is done currently. (Without further feedback we most likely would simply replace `process_command_line` and `process_configfile` in `do_reload`).

> Or do things have to be done the Elektra way from now on, by "mounting" configuration files

Mounting is a new possibility for you to, for example, use a different configuration file format, directly write into git instead of files, download files from a server instead using a local ones and [much more](https://www.libelektra.org/plugins/readme). But for users that want to keep the default (which seems like it will be the same INI file as it is now?), they do not have to bother about Elektra at all.

>  and editing them with kdb or similar tool?

The `kdb editor` spawns your favourite editor and aborts on syntax/validation errors. Think of it like `visudo`. But you do not have to use it--if you prefer a risky lifestyle ;)

> Although if Elektra does take off, I'll be more open to getting rid of old stuff, like lcdproc's not very well structured ini file, and replacing it with a better format.

In Elektra all users can select their own favourite format. We already have, for example JSON and INI, and we are currently working on full-blown XML (see #1280) and YAML. The default format obviously is something lcdproc can decide (also (re)decide at any later point of time).


## Implications

LCDproc will not only depend on any Elektra but on the yet-to-be-released 0.8.20.
We will delay the 0.8.20 release until all parts for LCDproc are tested and ready.
Progress can be viewed [here](git.libelektra.org/projects/7)

## Win-Win

Yes, it is early adoption but I think we can both profit from it. For lcdproc it will be a simplification of code while getting many more tools to work with configuration, for Elektra it will improve its adoption and packaging. For oyranos it works well on both sides, see our discussions here in the issue tracker, for example #1134.

## See also

We discussed about Alternatives to Elektra [here](http://issues.libelektra.org/1266).

If you also maintain an free or open source (FLOSS) project with an out-dated configuration system,
please contact us.
Obviously, we cannot fully port every FLOSS project ourselves, instead we will handle requests on a first come, first serve basis.
Earlier projects will also have an higher impact on the feature set of Elektra, thus you will less likely need to implement your own plugin.

